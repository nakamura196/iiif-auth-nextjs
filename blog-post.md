# IIIF認証の仕組みをわかりやすく解説

## はじめに

美術館や図書館のデジタルアーカイブで使われている「IIIF（トリプルアイエフ）」。その中でも特に重要な「認証」の仕組みについて、技術に詳しくない方にもわかりやすく解説します。

## IIIFとは？

IIIF（International Image Interoperability Framework）は、世界中の美術館、図書館、アーカイブが共通の方法で画像を公開・共有するための国際規格です。

たとえば、ルーブル美術館と東京国立博物館が同じ方法で画像を公開すれば、同じビューアーで両方の作品を見ることができます。

## なぜ認証が必要？

### 現実世界との比較

美術館を例に考えてみましょう：

1. **一般公開エリア** - 誰でも自由に見られる常設展示
2. **特別展示エリア** - チケットを購入した人だけが見られる企画展

デジタルアーカイブでも同じように：
- 一般公開画像：誰でも自由に閲覧可能
- 保護された画像：認証を受けた人だけが閲覧可能

## IIIF認証の流れ

### 1. 画像へのアクセスを試みる

```
訪問者：「この画像を見せてください」
　↓
サーバー：「この画像は保護されています。まず認証が必要です」
```

### 2. 認証サービスの案内

サーバーは「どこで認証すればよいか」を教えてくれます。これは美術館の入口で「チケット売り場はあちらです」と案内されるようなものです。

### 3. ログイン

専用のログイン画面が開き、ユーザー名とパスワードを入力します。

### 4. アクセストークンの発行

認証が成功すると「アクセストークン」が発行されます。これは美術館の「入場券」のようなものです。

```
ログインシステム：「認証成功！これがあなたの入場券（トークン）です」
```

### 5. トークンを使って画像にアクセス

入場券（トークン）を持って、もう一度画像にアクセスします。

```
訪問者：「この画像を見せてください。入場券も持っています」
　↓
サーバー：「入場券を確認しました。どうぞご覧ください」
```

## 技術的な仕組み（もう少し詳しく）

### JWT（ジェイ・ダブリュー・ティー）トークン

アクセストークンには「JWT」という形式がよく使われます。これは：
- **偽造防止**：美術館の入場券にホログラムがあるように、デジタル署名で守られています
- **有効期限**：1日券のように、一定時間で無効になります
- **情報を含む**：入場券に日付や名前が書かれているように、誰がいつ認証したかの情報が含まれています

### ポップアップウィンドウの利用

IIIF認証では、ログイン画面が別ウィンドウ（ポップアップ）で開くことがあります。これは：
- **安全性**：偽のログイン画面でパスワードを盗まれないようにするため
- **利便性**：元のページを離れずにログインできる

## 実装例での流れ

このデモシステムでの認証の流れを具体的に見てみましょう：

### 1. 未認証状態で画像を要求

```
ブラウザ → サーバー：「/api/iiif/image/sample/info.json を見たい」
サーバー → ブラウザ：「401 Unauthorized（認証が必要です）」
```

### 2. 認証サービスの確認

サーバーは「どこで認証すればよいか」も一緒に教えてくれます：

```json
{
  "error": "Authentication required",
  "service": [{
    "@context": "http://iiif.io/api/auth/2/context.json",
    "id": "http://localhost:3001/api/iiif/probe",
    "type": "AuthProbeService2"
  }]
}
```

### 3. Probe Service（認証状態の確認）

Probe Serviceに問い合わせて、詳しい認証方法を確認します：

```
ブラウザ → Probe Service：「認証状態を教えて」
Probe Service → ブラウザ：「未認証です。ここでログインしてください」
```

### 4. ログインウィンドウ

新しいウィンドウが開き、ログインフォームが表示されます。
- デモ用のユーザー名：`user`
- デモ用のパスワード：`pass`

### 5. トークン受け取り

ログインに成功すると、JavaScriptのpostMessageという仕組みを使って、元のページにトークンが送られます。

```javascript
// ログインウィンドウから元のページへ
window.opener.postMessage({
  messageId: "xxx-xxx-xxx",
  accessToken: "eyJhbGc...",  // これがトークン
  expiresIn: 3600  // 1時間有効
}, "http://localhost:3001");
```

### 6. トークンを使って再アクセス

トークンを「Authorization」ヘッダーに含めて、もう一度画像を要求します：

```
ブラウザ → サーバー：「/api/iiif/image/sample/info.json を見たい」
                   「Authorization: Bearer eyJhbGc...」
サーバー → ブラウザ：「認証確認OK。画像情報をどうぞ」
```

## セキュリティのポイント

### 1. トークンの保管

- ブラウザのlocalStorageに保存
- 他のサイトからはアクセスできない
- ブラウザを閉じても残る（設定による）

### 2. トークンの有効期限

- 通常1時間程度で無効になる
- 期限切れの場合は再ログインが必要

### 3. CORS（Cross-Origin Resource Sharing）

異なるドメイン間でも安全に画像を共有できるように設定されています。

## まとめ

IIIF認証は、デジタルアーカイブの画像を安全に共有するための仕組みです：

1. **標準化**：世界共通の方法で認証できる
2. **安全性**：トークンによる安全な認証
3. **利便性**：一度ログインすれば、複数の画像を見られる

美術館の入場券システムのように、シンプルで使いやすい仕組みを目指しています。

## 実際に試してみる

このデモシステムで実際に認証の流れを体験できます：

1. 「Simple Viewer」などのビューアーページへアクセス
2. 「Load Protected Image」ボタンをクリック
3. ログインウィンドウで `user` / `pass` でログイン
4. 保護された画像が表示される

## 技術者向け補足

### 使用している技術スタック

- Next.js 14 (App Router)
- JWT for authentication tokens
- IIIF Image API 3.0
- IIIF Authentication API 2.0

### 主要なエンドポイント

- `/api/iiif/probe` - 認証状態の確認
- `/api/iiif/access` - ログイン処理
- `/api/iiif/token` - トークン交換
- `/api/iiif/image/[id]/info.json` - 画像情報（要認証）
- `/api/iiif/image/[id]/[...params]` - 画像本体（要認証）

### 参考リンク

- [IIIF Authentication API 2.0 仕様書](https://iiif.io/api/auth/2.0/)
- [IIIF Image API 3.0 仕様書](https://iiif.io/api/image/3.0/)
- [JWT (JSON Web Token) について](https://jwt.io/introduction)